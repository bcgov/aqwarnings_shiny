---
title: "`r paste0(
  'Air quality warning ended for ', params$location)`" 
type: "local_emissions"
date: "`r Sys.Date()`"
params: 
  ice: End
  date: "`r Sys.Date()`"
  pollutant: "PM25 & PM10"
  burnRestrictions: "Yes"
  sel_aqMet: "Sakshi Jain"
  location: "Whistler"
  issuedate: "2025-07-09"
  outputFormat: ""
  customMessage: ""
format:
  markdown: default
  pdf:
    date-format: long
    include-in-header: 
      - src/header.tex
    fontsize: "11pt"
    urlcolor: bcblue
---

```{=html}
<!--
Copyright 2025 Province of British Columbia

This work is licensed under the Creative Commons Attribution 4.0 International License.
To view a copy of this license, visit http://creativecommons.org/licenses/by/4.0/.
-->
```

```{r setup, echo=FALSE, include=FALSE, warning=FALSE, message=FALSE}

knitr::opts_chunk$set(echo=FALSE,
                      message=FALSE,
                      warning=FALSE)

library(tidyverse)
library(knitr)
library(data.table)
library(shiny)
library(sf)
library(lubridate)
library(readr)
library(xtable)

source(here::here("load_metadata.r"))
```

```{r ENVcontact, include=FALSE}
#| label: ENVcontact
#| results: asis
#| strip.white: false

if (params$outputFormat == "markdown") sep_type <- "<br />" else sep_type <- "  \n"

# AQ met information
ENVcontact <- aq_mets |>
  filter(fullname == params$sel_aqMet) |>
  mutate(contact = paste(fullname_typeset, title, ministry, phone, sep = sep_type)) |> 
  pull(contact) 
```

```{r HAcontact, include=FALSE}
#| label: HAcontact
#| results: asis

if (params$outputFormat == "markdown") sep_type <- "<br />" else sep_type <- "  \n"

HAauth <- match_health_city %>%
  filter(location == params$location) %>%
  pull(health_city)

HAcontact <- health_contact |>
    filter(authority == HAauth) |>
    select(authority, contact) |>
    group_by(authority) |>
    summarise(html_string = paste(contact, collapse = sep_type))
```

```{r additional_info, include=FALSE}

additional_info_PM25 <- paste0(
    "The provincial air quality objective for PM$_{2.5}$ is 25 micrograms per cubic metre ($\\mu$g/m$^{3}$) averaged over 24 hours. 24-hour average PM$_{2.5}$ concentrations are summarized below for ", params$location, " and nearest monitored communities at ", format(floor_date(Sys.time(), "hour"), "%H:%M"), " local time today:"
  )

additional_info_PM10 <- paste0(
  "The provincial air quality objective for PM$_{10}$ is 50 micrograms per cubic metre ($\\mu$g/m$^{3}$), averaged over 24 hours. 24-hour average PM$_{10}$ concentrations are summarized below for ", params$location, " and nearest monitored communities at ", format(floor_date(Sys.time(), "hour"), "%H:%M"), " PST today:"
  )

additional_info_O3 <- paste0(
  "- The provincial air quality objectives for ozone is an eight-hour objective of 62 parts per billion (ppb) and a one-hour average of 82 ppb for air quality advisories. Air quality advisories for ground-level ozone may be issued when current concentrations exceed or are expected to exceed either of these objectives. \n",
  "- The 8-hour average ozone concentration and 1-hour maximum concentration (within the past 8 hours) are summarized below for ", params$location, " and nearest monitored communities at ", format(floor_date(Sys.time(), "hour"), "%H:%M"), " PST today:"
)
```

```{r pollutant_specific_clauses, include=FALSE}
pollutant_tbl <- tribble(
  ~pollutant,~pollutantExpansion,
  "PM25","fine particulate matter",
  "PM10","coarse particulate matter",
  "PM25 & PM10","fine particulate matter and coarse particulate matter",
  "O3","ground level ozone"
)

# Pick the row for the current pollutant
pollutant_info <- pollutant_tbl %>% filter(pollutant == params$pollutant)

# Assign values
pollutantExpansion  <- pollutant_info$pollutantExpansion

first_paragraph <- paste0(
    "The Ministry of Environment and Parks in collaboration with the ",
    HAauth, " has ended the Air Quality Warning that was issued on ", format(as.Date(params$issuedate), "%B %d, %Y"), " for ", params$location,
    " due to elevated levels of ", pollutantExpansion, "."
  )
```

```{r table-setup, include=FALSE}
pollutants <- strsplit(params$pollutant, "&")[[1]] %>% trimws()
locations <- params$location
COMPLETE_THRESHOLD_PCT <- 75

results <- list()

for (i in seq_along(pollutants)) {
  pollutant <- pollutants[i]

  # ---- Check that locations are valid for this pollutant ----
  valid_locations <- buddy_stations %>%
    filter(location %in% locations) %>%
    pull(Buddy_location) %>%
    unique()

  if (length(valid_locations) == 0) {
    stop(sprintf("None of the specified locations are valid for %s.", pollutant))
  }

  # ---- Lookup table for units and averaging times ----
  lookup <- data.frame(
    units = c("$\\mu$g/m$^{3}$", "$\\mu$g/m$^{3}$", "ppb"),
    hours = c(24, 24, 8),
    row.names = c("PM25", "PM10", "O3")
  ) %>%
    mutate(avgtimelabel = sprintf("%d-hr", hours))

  # ---- Read in CSV from FTP ----
  columndefs <- cols_only(
    DATE_PST = col_character(),
    STATION_NAME = col_factor(),
    RAW_VALUE = col_double(),
    REPORTED_VALUE = col_double(),
    INSTRUMENT = col_factor(),
    UNITS = col_character(),
    PARAMETER = col_character(),
    EMS_ID = col_character()
  )

  dfraw <- read_csv(
    sprintf("ftp://ftp.env.gov.bc.ca/pub/outgoing/AIR/Hourly_raw_air_data/Air_Quality/%s.csv", pollutant),
    col_types = columndefs
  )

  # ---- Clean and filter data ----
  df <- dfraw %>%
    mutate(DATE_PST = as.POSIXct(DATE_PST, format = "%Y-%m-%d %H:%M", tz = "Etc/GMT+8")) %>%
    filter(INSTRUMENT != "") %>%
    filter(STATION_NAME %in% valid_locations)

  # ---- Get time window per location ----
  dts <- df %>%
    group_by(STATION_NAME) %>%
    summarize(max_dt = max(DATE_PST), .groups = "drop") %>%
    mutate(min_dt = max_dt - (3600 * (lookup[pollutant, "hours"] - 1)))

  df_filtered <- df %>%
    left_join(dts, by = "STATION_NAME") %>%
    filter(DATE_PST >= min_dt & DATE_PST <= max_dt) %>%
    select(-min_dt, -max_dt)

  # ---- Summarize concentrations ----
  integrated <- df_filtered %>%
    group_by(STATION_NAME, PARAMETER) %>%
    summarize(
      n_hours = n(),
      n_na = sum(is.na(REPORTED_VALUE)),
      pct_valid = 100 * (n_hours - n_na) / n_hours,
      mean_conc = if_else(n_hours == n_na, NA_real_, mean(REPORTED_VALUE, na.rm = TRUE)),
      max_conc = if_else(n_hours == n_na, NA_real_, max(REPORTED_VALUE, na.rm = TRUE)),
      start_dt = min(DATE_PST),
      end_dt = max(DATE_PST),
      .groups = "drop"
    ) %>%
    mutate(
      mean_conc = na_if(mean_conc, pct_valid < COMPLETE_THRESHOLD_PCT),
      max_conc = na_if(max_conc, pct_valid < COMPLETE_THRESHOLD_PCT)
    )

  stationByParameterList <- read_rds(sprintf("./src/stations_%s.rds", tolower(pollutant)))

  # Join with station info using STATION_NAME
  integrated <- integrated %>%
    left_join(
      stationByParameterList %>% select(STATION_NAME, COMMUNITY),
      by = "STATION_NAME"
    )

  # ---- Format wide table ----
  table2 <- integrated %>%
    mutate(
      mean_conc = ifelse(is.finite(mean_conc), sprintf("%.1f", mean_conc), "NA"),
      max_conc = ifelse(is.finite(max_conc), sprintf("%.1f", max_conc), "NA")
    ) %>%
    pivot_wider(
      names_from = PARAMETER,
      id_cols = c(STATION_NAME, COMMUNITY),
      values_from = c(mean_conc, max_conc)
    ) %>%
    rename(location = STATION_NAME, Community = COMMUNITY)

  # ---- Clean up table: remove suffixes ----
  table2 <- table2 %>%
    rename_with(~ gsub(sprintf("_%s", pollutant), "", .x), everything())

  table2 <- table2[ , -1]

  # ---- Transpose and finalize ----
  pt2 <- t(table2) %>% as.data.frame() %>% rownames_to_column()
  colnames(pt2) <- pt2[1, ]
  pt3 <- pt2[-c(1), ]
  
  pt3 <- as.data.frame(pt3, stringsAsFactors = FALSE)


  if (pollutant != "O3") {
  pt4 <- pt3 %>% filter(Community != "max_conc")
  } else {
  pt4 <- pt3
  }

  # ---- Final format ----
  final_table <- pt4 %>%
    mutate(Community = case_when(
      Community == "mean_conc" ~ sprintf("%s average (%s)", lookup[pollutant, "avgtimelabel"], lookup[pollutant, "units"]),
      Community == "max_conc" ~ sprintf("Max. within %s (%s)", gsub("-", " ", lookup[pollutant, "avgtimelabel"]), lookup[pollutant, "units"]),
      TRUE ~ Community
    ))

  results[[paste0("final_table", i)]] <- final_table
}

# Expose them as final_table1, final_table2, etc.
list2env(results, envir = .GlobalEnv)
```


```{r}
#| label: create-logo-list

# Identify which set of logos to include in document header (note: BC Gov and FNHA logos are included in all cases so are not used to define logo file name)
# This list contains the full name (used for Alt Text and identification) on the left as the keys of the list and the initials (used for the logo file name) on the right as values of the list
logos_list <- list(
  "Government of British Columbia" = "BCID_V_RGB_pos",
  "First Nations Health Authority" = "FNHA",
  "Interior Health Authority" = "IH",
  "Fraser Health Authority" = "FH",
  "Vancouver Coastal Health Authority" = "VCH",
  "Vancouver Island Health Authority" = "VIH",
  "Northern Health Authority" = "NH"
)

# Logos selected by user and ordered as per logos_list
# Logos selected by user
logos_names_selected <- c("Government of British Columbia",
                          "First Nations Health Authority", 
                          HAauth)
logos_selected <- logos_list[logos_names_selected]

# Count number of logos to display
n_logos <- length(logos_selected)

logo_image_line <- c()
logos_combined <- c()

# Set logo path based on output format
if (params$outputFormat == "markdown") {
  logo_path <- " logo](//assets/logo_"

  # Build a vector of quarto lines to insert image for each logo
  # It is more efficient to use `sapply` but this might be more readable

  # Add each logo's insert line to the vector
  for (logo_name in names(logos_selected)) {
    logo_image_line <- c(logo_image_line,
                         paste0("![", logo_name, logo_path, logos_selected[[logo_name]], ".png)\\"))
  }}

if (params$outputFormat == "pdf") {
  
  logo_path <- "https://github.com/bcgov/aqwarnings/blob/main/frontend/assets/logo_"
  logo_urls <- c() #start with empty vector
  
  # create vector of urls
  for (logo_name in names(logos_selected)) {
    logo_urls <- c(
      logo_urls, 
      paste0(logo_path,
             logos_selected[[logo_name]],
             ".png?raw=true"
             )
    )
  }

# format logos
logos <- magick::image_read(logo_urls) |> 
  magick::image_trim() |> # remove all white space
  magick::image_border(color = "none", geometry = "100x25") |> # add uniform white space to top and right side of each image
  magick::image_scale("x200") # scale

# Combine logos into single image and scale
logos_combined <- magick::image_append(logos) |> 
  magick::image_write(path = "logo.png")
}
```


<!-- Logo header, the layout-col should be set based on number of logos including FHNA and BCGov -->
<!-- the trailing slash means the text in square brackets is alt text -->

[`r paste("::: {layout-ncol=", n_logos," layout-valign=\"bottom\"}")`]{.content-visible when-format="markdown"}

```{r}
#| label: print-logos
#| results: asis

# `cat` is used to avoid extra processing
# `sep` argument adds the line break and then a new line as required
if (params$outputFormat == "markdown") cat(logo_image_line, sep="\n\n") 
```

[`r paste(":::")`]{.content-visible when-format="markdown"}

The Ministry of Environment and Parks in collaboration with the `r HAauth` has ended the air quality warning that was issued `r format(as.Date(params$issuedate), '%B %d, %Y')` for `r params$location` due to elevated concentrations of `r pollutantExpansion`. 

`r params$customMessage`

Visit the provincial [air quality data webpage](https://www2.gov.bc.ca/gov/content/environment/air-land-water/air/air-quality) for real-time observations.

# More information

```{r final-table, results='asis', echo=FALSE}

# Single pollutant: PM25
if (length(pollutants) == 1 && pollutants == "PM25") {
  cat(additional_info_PM25, "\n\n")
  print(knitr::kable(final_table, row.names = FALSE))
}

# Single pollutant: PM10
if (length(pollutants) == 1 && pollutants == "PM10") {
  cat(additional_info_PM10, "\n\n")
  print(knitr::kable(final_table, row.names = FALSE))
}

# Single pollutant: O3
if (length(pollutants) == 1 && pollutants == "O3") {
  cat(additional_info_O3, "\n\n")
  print(knitr::kable(final_table, row.names = FALSE))
}

# Both PM25 & PM10
if (all(c("PM25", "PM10") %in% pollutants)) {
  # PM25
  cat(additional_info_PM25, "\n\n")
  print(knitr::kable(final_table1, row.names = FALSE))
  
  cat("\n\n")  # spacing
  
  # PM10
  cat(additional_info_PM10, "\n\n")
  print(knitr::kable(final_table2, row.names = FALSE))
}

```

# Contact information

**Media questions regarding air quality conditions related to this Air Quality Warning:**

[{{< card_start width="wide" >}}]{.content-visible when-format="markdown"} `r ENVcontact` [{{< card_end >}}]{.content-visible when-format="markdown"}

**Media questions regarding health implications related to degraded air quality:**

[{{< card_start  width="wide" >}}]{.content-visible when-format="markdown"}`r paste(HAcontact$html_string, collapse = "\n\n")`[{{< card_end >}}]{.content-visible when-format="markdown"}