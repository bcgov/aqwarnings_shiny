---
date: "`r Sys.Date()`"
params: 
  ice: End
  date: "`r Sys.Date()`"
  pollutant: PM25
  burnRestrictions: "Yes"
  sel_aqMet: "Sakshi Jain"
  station: "Whistler"
  nextBulletin: "2025-05-08"
  issuedate: "2025-07-09"
  outputFormat: ""
format:
  markdown: default
  pdf:
    date-format: long
    include-in-header: 
      - src/header.tex
    mainfont: BCSans-Regular
    mainfontoptions:
      - Boldfont = BCSans-Bold
      - ItalicFont = BCSans-Italic
    fontsize: "11pt"
    urlcolor: bcblue
---

```{=html}
<!--
Copyright 2025 Province of British Columbia

This work is licensed under the Creative Commons Attribution 4.0 International License.
To view a copy of this license, visit http://creativecommons.org/licenses/by/4.0/.
-->
```

```{r setup, echo=FALSE, include=FALSE, warning=FALSE, message=FALSE}

knitr::opts_chunk$set(echo=FALSE,
                      message=FALSE,
                      warning=FALSE)

library(tidyverse)
library(knitr)
library(data.table)
library(shiny)
library(sf)
library(lubridate)
library(readr)
library(xtable)

source(here::here("load_metadata.r"))
```

```{r additional_info, include=FALSE}

additional_info_PM25 <- paste0(
    "- The provincial air quality objective for PM$_{2.5}$ is 25 micrograms per cubic metre ($\\mu$g/m$^{3}$) averaged over 24 hours. 24-hour average PM$_{2.5}$ concentrations are summarized below for ", params$station, " and nearest monitored communities at ", format(floor_date(Sys.time(), "hour"), "%H:%M"), " PST today:"
  )

additional_info_PM10 <- paste0(
  "- The provincial air quality objective for PM$_{10}$ is 50 micrograms per cubic metre ($\\mu$g/m$^{3}$), averaged over 24 hours. 24-hour average PM$_{10}$ concentrations are summarized below for ", params$station, " and nearest monitored communities at ", format(floor_date(Sys.time(), "hour"), "%H:%M"), " PST today:"
  )

additional_info_O3 <- paste0(
  "- The provincial air quality objectives for ozone is an eight-hour objective of 62 parts per billion (ppb) and a one-hour average of 82 ppb for air quality advisories. Air quality advisories for ground-level ozone may be issued when current concentrations exceed or are expected to exceed either of these objectives. \n",
  "- The 8-hour average ozone concentration and 1-hour maximum concentration (within the past 8 hours) are summarized below for ", params$station, " and nearest monitored communities at ", format(floor_date(Sys.time(), "hour"), "%H:%M"), " PST today:"
)
```

```{r burn_ban_clauses, include=FALSE}

if (params$burnRestrictions == "Yes") {
  title_burn_advisory <- "and open burning restrictions"
} else {
  title_burn_advisory <- NULL
  burn_ban <- NULL
  burn_ban_bylaw <- NULL
}
```

```{r pollutant_specific_clauses, include=FALSE}

if (params$pollutant == "PM25") {
  pollutantExpansion <- "fine particulate matter"
  additional_info <- additional_info_PM25
} else if (params$pollutant == "PM10") {
  pollutantExpansion <- "coarse particulate matter"
  additional_info <- additional_info_PM10
} else if (params$pollutant == "O3") {
  pollutantExpansion <- "ozone"
  additional_info <- additional_info_O3
} else {
  title_pollutant <- NULL
  background <- NULL
}
```

```{r ENVcontact, include=FALSE}
ENVcontact <- aq_mets |>
  filter(nickname == params$sel_aqMet) |>
  mutate(contact = paste(fullname_typeset, title, ministry, phone, sep = "<br />")) |> 
  pull(contact)
```

```{r HAcontact, include=FALSE}

HAauth <- Health_Authority %>%
  filter(Station == params$station) %>%
  pull(Health_authority)

HAcontact <- health_contact |>
    filter(authority == HAauth) |>
    select(authority, contact) |>
    group_by(authority) |>
    summarise(html_string = paste(contact, collapse = "<br />"))

```

```{r table-setup, include=FALSE}

pollutant <- params$pollutant
stations <- params$station

COMPLETE_THRESHOLD_PCT <- 75

# ---- Check that stations are valid for this pollutant ----
valid_stations <- buddy_stations %>%
  filter(Station %in% stations) %>%
  pull(Buddy_location) %>%
  unique()

if (length(valid_stations) == 0) {
  stop("None of the specified stations are valid for this pollutant.")
}

# ---- Lookup table for units and averaging times ----
lookup <- data.frame(
  units = c("$\\mu$g/m$^{3}$", "$\\mu$g/m$^{3}$", "ppb"),
  hours = c(24, 24, 8),
  row.names = c("PM25", "PM10", "O3")
) %>%
  mutate(avgtimelabel = sprintf("%d-hr", hours))

# ---- Read in CSV from FTP ----
columndefs <- cols_only(
  DATE_PST = col_character(),
  STATION_NAME = col_factor(),
  RAW_VALUE = col_double(),
  REPORTED_VALUE = col_double(),
  INSTRUMENT = col_factor(),
  UNITS = col_character(),
  PARAMETER = col_character(),
  EMS_ID = col_character()
)

dfraw <- read_csv(
  sprintf("ftp://ftp.env.gov.bc.ca/pub/outgoing/AIR/Hourly_raw_air_data/Air_Quality/%s.csv", pollutant),
  col_types = columndefs
)

# ---- Clean and filter data ----
df <- dfraw %>%
  mutate(DATE_PST = as.POSIXct(DATE_PST, format = "%Y-%m-%d %H:%M", tz = "Etc/GMT+8")) %>%
  filter(INSTRUMENT != "") %>%
  filter(STATION_NAME %in% valid_stations)


# ---- Get time window per station ----
dts <- df %>%
  group_by(STATION_NAME) %>%
  summarize(max_dt = max(DATE_PST), .groups = "drop") %>%
  mutate(min_dt = max_dt - (3600 * (lookup[pollutant, "hours"] - 1)))

df_filtered <- df %>%
  left_join(dts, by = "STATION_NAME") %>%
  filter(DATE_PST >= min_dt & DATE_PST <= max_dt) %>%
  select(-min_dt, -max_dt)

# ---- Summarize concentrations ----
integrated <- df_filtered %>%
  group_by(STATION_NAME, PARAMETER) %>%
  summarize(
    n_hours = n(),
    n_na = sum(is.na(REPORTED_VALUE)),
    pct_valid = 100 * (n_hours - n_na) / n_hours,
    mean_conc = if_else(n_hours == n_na, NA_real_, mean(REPORTED_VALUE, na.rm = TRUE)),
    max_conc = if_else(n_hours == n_na, NA_real_, max(REPORTED_VALUE, na.rm = TRUE)),
    start_dt = min(DATE_PST),
    end_dt = max(DATE_PST),
    .groups = "drop"
  ) %>%
  mutate(
    mean_conc = na_if(mean_conc, pct_valid < COMPLETE_THRESHOLD_PCT),
    max_conc = na_if(max_conc, pct_valid < COMPLETE_THRESHOLD_PCT)
  )

stationByParameterList <- read_rds(sprintf("./utility/stations_%s.rds", tolower(pollutant)))

# Join with station info using STATION_NAME
integrated <- integrated %>%
  left_join(
    stationByParameterList %>% select(STATION_NAME, COMMUNITY),
    by = "STATION_NAME"
  )

# ---- Format wide table ----
table2 <- integrated %>%
  mutate(
    mean_conc = ifelse(is.finite(mean_conc), sprintf("%.1f", mean_conc), "NA"),
    max_conc = ifelse(is.finite(max_conc), sprintf("%.1f", max_conc), "NA")
  ) %>%
  pivot_wider(
    names_from = PARAMETER,
    id_cols = c(STATION_NAME, COMMUNITY),
    values_from = c(mean_conc, max_conc)
  ) %>%
  rename(Station = STATION_NAME, Community = COMMUNITY)

# ---- Clean up table: remove suffixes ----
table2 <- table2 %>%
  rename_with(~ gsub(sprintf("_%s", pollutant), "", .x), everything())

table2 <- table2[ , -1]

# ---- Transpose and finalize ----
pt2 <- t(table2) %>% as.data.frame() %>% rownames_to_column()
colnames(pt2) <- pt2[1, ]
pt3 <- pt2[-c(1), ]  # drop row names and station name if only one station

if (pollutant == "O3") {
    pt4 <- pt3
  } else {
    pt4 <- pt3 %>% filter(Community != "max_conc")
}

# ---- Final format ----
final_table <- pt4 %>%
  mutate(Community = case_when(
    Community == "mean_conc" ~ sprintf("%s average (%s)", lookup[pollutant, "avgtimelabel"], lookup[pollutant, "units"]),
    Community == "max_conc" ~ sprintf("Max. within %s (%s)", gsub("-", " ", lookup[pollutant, "avgtimelabel"]), lookup[pollutant, "units"]),
    TRUE ~ Community
  ))

```


```{r}

logos_list <- list(
  "Government of British Columbia" = "BCID_V_RGB_pos",
  "First Nations Health Authority" = "FNHA",
  "Interior Health Authority" = "IH", 
  "Fraser Health Authority" = "FH", 
  "Vancouver Coastal Health Authority" = "VCH", 
  "Vancouver Island Health Authority" = "VIH", 
  "Northern Health Authority" = "NH")

# Logos selected by user and ordered as per logos_list
# Logos selected by user
logos_selected_names <- c("Government of British Columbia", HAauth)

# Get the correct logo codes (e.g., "BCID_V_RGB_pos", "VCH")
logos_selected <- logos_list[logos_selected_names]  # this returns a named list

# Build image lines
logo_image_line <- c()
for (logo_name in names(logos_selected)) {
  logo_image_line <- c(
    logo_image_line,
    paste0("![", logo_name, " logo](/utility/logos/logo_", logos_selected[[logo_name]], ".png){width=150px}\\")
  )
}

```

```{r}
#| results: asis
cat(logo_image_line, sep = " ")
```



# Air quality warning `r title_burn_advisory` ended for `r params$station`

The Ministry of Environment and Parks in collaboration with the `r HAauth` has ended the air quality warning that was issued `r format(as.Date(params$issuedate), '%B %d, %Y')` for `r params$station` due to elevated concentrations of `r pollutantExpansion`. Changing meteorological conditions have improved conditions across the region.

Real-time air quality observations and information regarding the health effects of air pollution can be found at: [Air Quality Data](https://www.gov.bc.ca/airquality).

# Additional Information

`r additional_info`

```{r final-table}
kable(final_table, row.names = FALSE)
```

# Contacts

`r ENVcontact`

`r HAcontact$html_string`
