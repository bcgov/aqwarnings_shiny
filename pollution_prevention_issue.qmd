---
title: "`r paste('Pollution Prevention Notice and open burning restrictions are in effect within', params$burnRestrictionArea)`"
type: "pollution_prevention"
date: "`r Sys.Date()`"
params: 
  ice: "Issue" # Issue; Continue
  sel_aqMet: "Sakshi Jain"
  nearestMonitor: "Prince George"
  issuedate: "2025-07-20"
  nextUpdate: "2025-09-28"
  outputFormat: "markdown"
  customMessage: ""
  burnRestrictions: 1   # 1 = Yes (Ben); 2 = Yes (TBD)
  burnRestrictionArea: ""
  burnRestrictionEndDate: "2025-09-28"
  burnRestrictionEndTime: "12:00 PM"
ice: "`r params$ice`"
author: "`r params$sel_aqMet`"
customMessage: "`r params$customMessage`"
location: "`r params$nearestMonitor`"
outputFormat: "`r params$outputFormat`"
burnRestrictions: "`r params$burnRestrictions`"
format:
  markdown: default
  pdf:
    mainfont: "Roboto"
    date-format: long
    include-in-header: 
      - src/header.tex
    fontsize: "12pt"
    urlcolor: bcblue
---
```{=html}
<!--
Copyright 2025 Province of British Columbia

This work is licensed under the Creative Commons Attribution 4.0 International License.
To view a copy of this license, visit http://creativecommons.org/licenses/by/4.0/.
-->
```

```{r setup, echo=FALSE, include=FALSE, warning=FALSE, message=FALSE}

knitr::opts_chunk$set(echo=FALSE,
                      message=FALSE,
                      warning=FALSE)

library(tidyverse)   #could this be streamlined?
library(knitr)
library(data.table)
library(shiny)
library(sf)
library(lubridate)
library(readr)
library(xtable)
library(tibble)
library(dplyr)

source(here::here("load_metadata.r"))
source(here::here(file.path("functions", "local_tz.r")))

# date/time information 
current_month <- as.numeric(format(Sys.Date(), "%m"))
# create single line break based on output file format
if (params$outputFormat == "markdown") sep_type <- "<br />" else sep_type <- "  \n"

```

```{r table-setup, include=FALSE}

pollutants <- "PM25"
min_data_capture_pct <- 75

results <- list()

for (i in seq_along(pollutants)) {
  pollutant <- pollutants
  
  # ---- Check that locations are valid for this pollutant ----
  valid_locations <- buddy_stations |> 
    filter(location %in% params$nearestMonitor) |> 
    pull(Buddy_location) |> 
    unique()
  
  if (length(valid_locations) == 0) {
    stop(sprintf("None of the specified locations are valid for %s.", pollutant))
  }
  
  # ---- Lookup table for units and averaging times ----
  lookup <- data.frame(
    units = c("μg/m^3^", "μg/m^3^", "ppb"),
    hours = c(24, 24, 8),
    row.names = c("PM25", "PM10", "O3")
  ) |> 
    mutate(avgtimelabel = sprintf("%d-hr", hours))
  
  # ---- Read in CSV from FTP ----
  columndefs <- cols_only(
    DATE_PST = col_character(),  # time zone assigned later; col_datetime does not support time zone assignment
    STATION_NAME = col_factor(),
    INSTRUMENT = col_factor(),  #is instrument necessary?
    REPORTED_VALUE = col_double(),
    PARAMETER = col_character(),
    EMS_ID = col_character()
  )
  
  dfraw <- read_csv(
    sprintf("ftp://ftp.env.gov.bc.ca/pub/outgoing/AIR/Hourly_Raw_Air_Data/Air_Quality/%s.csv", pollutant),
    col_types = columndefs
  ) |> 
    rename_all(tolower)
  
  # ---- Filter data to retain pnly stations relevant to this warning (params$nearestMonitor + neighbouring sites) ----
  df <- dfraw |> 
    mutate(date_pst = as.POSIXct(date_pst, format = "%Y-%m-%d %H:%M", tz = "Etc/GMT+8")) |> 
    filter(instrument != "") |>   #is this needed?
    filter(station_name %in% valid_locations)
  
  # ---- Get time window per location ----
  dts <- df |> 
    group_by(station_name) |> 
    summarize(max_dt = max(date_pst), .groups = "drop") |> 
    mutate(min_dt = max_dt - (3600 * (lookup[pollutant, "hours"] - 1)))
  
  df_filtered <- df |> 
    left_join(dts, by = "station_name") |> 
    filter(date_pst >= min_dt & date_pst <= max_dt) |> 
    select(-min_dt, -max_dt)
  
  # ---- Summarize concentrations ----
  integrated <- df_filtered |> 
    group_by(station_name, parameter) |> 
    summarize(
      n_hours = n(),
      n_na = sum(is.na(reported_value)),
      pct_valid = 100 * (n_hours - n_na) / n_hours,
      mean_conc = if_else(n_hours == n_na, NA_real_, mean(reported_value, na.rm = TRUE)),
      max_conc = if_else(n_hours == n_na, NA_real_, max(reported_value, na.rm = TRUE)),
      start_dt = min(date_pst),
      end_dt = max(date_pst),
      .groups = "drop"
    ) |> 
    mutate(
      mean_conc = na_if(mean_conc, pct_valid < min_data_capture_pct),
      max_conc = na_if(max_conc, pct_valid < min_data_capture_pct)
    )
  
  station_metadata_raw <- read_csv("ftp://ftp.env.gov.bc.ca/pub/outgoing/AIR/Hourly_Raw_Air_Data/Year_to_Date/bc_air_monitoring_stations.csv", show_col_types = FALSE) 
  station_metadata <- station_metadata_raw |> 
    rename_all(tolower) |> 
    select(station_name, location = city) |> 
    distinct()
  
  # Join with station info using STATION_NAME
  integrated <- integrated |> 
    left_join(station_metadata, by = "station_name")
  
  # ---- Define most recent hour of data and express as 12 hour clock and local time 
  
  # set system to local time of params$nearestMonitor
  Sys.setenv(TZ = local_tz(params$nearestMonitor))
  
  local_time <- integrated |> 
    filter(location == params$nearestMonitor) |> 
    pull(end_dt) |> 
    as.POSIXct(., tz = local_tz(params$nearestMonitor))
  
  local_hour <- format(lubridate::floor_date(local_time, "hour"), format = "%l:00 %p")
  
  # ---- Format final table ----
  formatted_table <- integrated |> 
    mutate(
      mean_conc = ifelse(is.finite(mean_conc), sprintf("%.1f", mean_conc), "NA"),
      max_conc = ifelse(is.finite(max_conc), sprintf("%.1f", max_conc), "NA")
    ) |> 
    pivot_wider(
      names_from = parameter,
      id_cols = c(station_name, location),
      values_from = c(mean_conc, max_conc)
    )
  
  # clean up names, drop station_name and sort by params$nearestMonitor then other stations alphabetically
  formatted_table <- formatted_table |> 
    rename_with(~ gsub(sprintf("_%s", pollutant), "", .x), everything()) |> 
    select(-station_name) |> 
    arrange(location != params$nearestMonitor)  # arrange rows with params$nearestMonitor first, then rest
  
  # transpose
  formatted_table <- formatted_table |> 
    pivot_longer(cols = -location, names_to = "Community", values_to = "concentration") |> 
    pivot_wider(names_from = "location", values_from = "concentration")
  
  # clean up labels
  final_table <- formatted_table |> 
    mutate(Community = case_when(
      Community == "mean_conc" ~ sprintf("%s average (%s)", lookup[pollutant, "avgtimelabel"], lookup[pollutant, "units"]),
      Community == "max_conc" ~ sprintf("Max. within %s (%s)", gsub("-", " ", lookup[pollutant, "avgtimelabel"]), lookup[pollutant, "units"]),
      TRUE ~ Community
    ))
  
  results[[paste0("final_table", i)]] <- final_table
}

# Expose them as final_table1, final_table2, etc.
list2env(results, envir = .GlobalEnv)
```

```{r ENVcontact, include=FALSE}
#| results: asis
#| strip.white: false

# AQ met information
ENVcontact <- aq_mets |>
  filter(fullname == params$sel_aqMet) |>
  mutate(contact = paste(fullname_typeset, title, ministry, phone, sep = sep_type)) |> 
  pull(contact) 
```

```{r HAcontact, include=FALSE}
#| results: asis

HAauth <- match_health_city |> 
  filter(location == params$nearestMonitor) |> 
  pull(health_city)

HAcontact <- health_contact |>
  filter(authority == HAauth) |>
  select(authority, contact) |>
  group_by(authority) |>
  summarise(html_string = paste(contact, collapse = sep_type))
```

```{r voluntary_reduction, include=FALSE}

voluntary_reduction_PM25 <- paste0(
  if (current_month %in% c(10:12, 1:4)) {
    "- Avoid using wood stoves and fireplaces unless it is the sole heating source. If wood burning is the sole heating source, burn dry, seasoned wood and ensure an adequate supply of combustion air.\n"
  } else {
    ""
  },
  "- Avoid backyard burning.\n",
  "- Reduce vehicle use where possible and avoid idling vehicles.\n",
  sep=""
)
```

```{r pollutant_specific_clauses, include=FALSE}

# Lookup table for pollutants
pollutant_tbl <- tribble(
  ~pollutant,~pollutantExpansion,~voluntary_reduction,
  "PM25","fine particulate matter",voluntary_reduction_PM25,
)

# Pick the row for the current pollutant
pollutant_info <- pollutant_tbl |> filter(pollutant == "PM25")

# Assign values
pollutantExpansion  <- pollutant_info$pollutantExpansion
voluntary_reduction <- pollutant_info$voluntary_reduction

# Build first_paragraph
if (params$ice == "Issue") {
  first_paragraph <- paste0(
    "The Ministry of Environment and Parks in collaboration with the ",
    HAauth, " has issued a Pollution Prevention Notice within ", params$burnRestrictionArea,
    " due to elevated ", pollutantExpansion, "."
  )
} else if (params$ice == "Continue") {
  first_paragraph <- paste0(
    "The Ministry of Environment and Parks in collaboration with the ",
    HAauth, " issued Pollution Prevention Notice within ", params$burnRestrictionArea,
    " on ", format(as.Date(params$issuedate), "%B %d, %Y"),
    ". The warning remains in effect due to elevated ", pollutantExpansion, "."
  )
}

```

```{r additional_info, include=FALSE, results='asis'}

additional_info_PM25 <- paste0(
  "Fine particulate matter refers to airborne solid or liquid droplets with diameters of 2.5 micrometers (μm) or less.  PM~2.5~ levels tend to be highest around busy roads, industrial operations and neighbourhoods with residential wood burning. PM~2.5~ can easily penetrate indoors because of their small size. Common sources of PM~2.5~ that contribute to episodes of poor air quality  vary seasonally but can include wood smoke (from wood stoves and/or open burning) as well as emissions from industry and transportation sources such as automobiles, trucks and rail traffic.
    
The provincial air quality objective for PM~2.5~ is 25 micrograms per cubic metre (μg/m^3^) averaged over 24 hours. 24-hour average PM~2.5~ concentrations are summarized below for ", params$location, " and nearest monitored communities at ", local_hour, " local time today:"
)
```

```{r burn_ban, results='asis', echo=FALSE}

# Define signature and title info depending on who it is
  if (params$burnRestrictions == 1) {
    name_line <- "Benjamin Weinstein"
    title_line1 <- "For Director, Environmental Management Act"
    title_line2 <- "Environmental Monitoring and Analysis Branch"
  } else if (params$burnRestrictions == 2) {
    name_line <- "TBD"
    title_line1 <- "Director, Environmental Management Act"
    title_line2 <- "Environmental Monitoring and Analysis Branch"
  }
  
# to do: improve formatting - single line spacing for sdm information, \n and <br> don't seem to work; rather than using paste could this text be added to a conditional code block directly in the document?
burn_ban <- paste0(
  "NOTICE of DIRECTOR under s.30 Open Burning Smoke Control Regulation:\n\n",
  "> As pollution is occurring or is likely to occur from open burning, pursuant to Sections 30(1) and 30(2) of the Open Burning Smoke Control Regulation, the Director has prohibited open burning within ",
  params$burnRestrictionArea, 
  " until ", 
  format(as.Date(params$burnRestrictionEndDate), "%B %d, %Y"), 
  " ",
  params$burnRestrictionEndTime, 
  " local time. No vegetative debris may be ignited or added to ignited piles. Contravention of these provisions may be subject to a fine under the Regulation.\n\n",
  "&emsp;&emsp;&nbsp;Date issued: ", format(Sys.Date(), "%B %d, %Y"), sep_type,
  "&emsp;&emsp;&nbsp;", name_line, sep_type,  
  "&emsp;&emsp;&nbsp;", title_line1, sep_type,
  "&emsp;&emsp;&nbsp;", title_line2
  )

```

```{r create-logo-list}
# Identify which set of logos to include in document header (note: BC Gov and FNHA logos are included in all cases so are not used to define logo file name)
# This list contains the full name (used for Alt Text and identification) on the left as the keys of the list and the initials (used for the logo file name) on the right as values of the list
logos_list <- list(
  "Government of British Columbia" = "BCID_V_RGB_pos",
  "First Nations Health Authority" = "FNHA",
  "Interior Health Authority" = "IH",
  "Fraser Health Authority" = "FH",
  "Vancouver Coastal Health Authority" = "VCH",
  "Vancouver Island Health Authority" = "VIH",
  "Northern Health Authority" = "NH"
)

# Logos selected by user and ordered as per logos_list
# Logos selected by user
logos_names_selected <- c("Government of British Columbia",
                          "First Nations Health Authority", 
                          HAauth)
logos_selected <- logos_list[logos_names_selected]

# Count number of logos to display
n_logos <- length(logos_selected)

logo_image_line <- c()
logos_combined <- c()

# Set logo path based on output format
if (params$outputFormat == "markdown") {
  logo_path <- " logo](//assets/logo_"
  
  # Build a vector of quarto lines to insert image for each logo
  # It is more efficient to use `sapply` but this might be more readable
  
  # Add each logo's insert line to the vector
  for (logo_name in names(logos_selected)) {
    logo_image_line <- c(logo_image_line,
                         paste0("![", logo_name, logo_path, logos_selected[[logo_name]], ".png)\\"))
  }}

if (params$outputFormat == "pdf") {
  
  logo_path <- "https://github.com/bcgov/aqwarnings/blob/main/frontend/assets/logo_"
  logo_urls <- c() #start with empty vector
  
  # create vector of urls
  for (logo_name in names(logos_selected)) {
    logo_urls <- c(
      logo_urls, 
      paste0(logo_path,
             logos_selected[[logo_name]],
             ".png?raw=true"
      )
    )
  }
  
  # format logos
  logos <- magick::image_read(logo_urls) |> 
    magick::image_trim() |> # remove all white space
    magick::image_border(color = "none", geometry = "100x25") |> # add uniform white space to top and right side of each image
    magick::image_scale("x200") # scale
  
  # Combine logos into single image and scale
  logos_combined <- magick::image_append(logos) |> 
    magick::image_write(path = "logo.png")
}
```

<!-- Logo header, the layout-col should be set based on number of logos including FHNA and BCGov -->
<!-- the trailing slash means the text in square brackets is alt text -->

[`r paste("::: {layout-ncol=", n_logos," layout-valign=\"bottom\"}")`]{.content-visible when-format="markdown"}

```{r print-logos}
#| results: asis

# `cat` is used to avoid extra processing
# `sep` argument adds the line break and then a new line as required
if (params$outputFormat == "markdown") cat(logo_image_line, sep="\n\n") 
```

[`r paste(":::")`]{.content-visible when-format="markdown"}

`r first_paragraph`

```{r, results='asis', echo=FALSE}
cat(
    "Open burning restrictions are now in effect within ", params$burnRestrictionArea,
    ". No new fires may be initiated, and no additional material may be added to existing fires. For more information on burning restrictions, refer to the Mandatory Emission Reduction Actions section below.",
    sep = ""
  )
```

Exposure to `r pollutantExpansion` is particularly a concern for infants, older adults, individuals with chronic conditions (such as asthma, COPD, heart disease, and diabetes) or respiratory infections, and those who are pregnant. Persons with chronic underlying medical conditions or acute infections should postpone or reduce strenuous exercise until the warning is ended. Anyone experiencing symptoms such as continuing eye or throat irritation, chest discomfort, shortness of breath, cough or wheezing, should follow the advice of their health care provider. Staying indoors helps to reduce exposure.

`r params$customMessage`

The next update will be on `r format(as.Date(params$nextUpdate), "%B %d, %Y")` and posted to the province’s [Air Quality Warnings webpage](https://www.gov.bc.ca/airquality).

Visit the provincial [air quality data webpage](https://www2.gov.bc.ca/gov/content/environment/air-land-water/air/air-quality) for real-time observations.

## Actions you can take

As air contaminant levels increase, health risks increase. Consider reducing or rescheduling outdoor sports, activities and events.

People more likely to be negatively impacted by outdoor air pollution should reduce or reschedule strenuous activities outdoors or seek medical attention if experiencing symptoms. This includes people aged 65 and older, pregnant individuals, infants and young children, people with an existing illness or chronic health condition such as chronic obstructive pulmonary disease (COPD), heart disease and diabetes, and people who work outdoors.

::: {.content-visible when-format="markdown"}
{{< accordion_controls >}}

{{< accordion_start title="Follow your common sense" initiallyOpen="true" >}}
:::

::: {.content-visible when-format="pdf"}
### Follow your common sense
:::

- Stop or reduce your activity level if breathing becomes uncomfortable or you feel unwell.

```{r, results='asis', echo=FALSE}

if (current_month %in% 6:8) {
  cat("- During warm weather, stay cool and drink plenty of fluids.", sep_type)
}
```

- Always carry any rescue medications with you.
- Make sure that children and others who cannot care for themselves follow the same advice.

::: {.content-visible when-format="markdown"}
{{< accordion_end >}}
{{< accordion_start title="Monitor your symptoms" initiallyOpen="true" >}}
:::

::: {.content-visible when-format="pdf"}
### Monitor your symptoms
:::

- Different people have different responses to elevated levels of air contaminants.
- Mild irritation and discomfort such as eye, nose and throat irritation, headaches or a mild cough are common, and usually disappear when the air contaminants return to typical levels.
- More serious but less common symptoms include wheezing, chest pains or severe cough.
- People with asthma or other chronic illness should follow any personal care plans designed with their family physicians.
- If you are unsure whether you need medical care, call HealthLink BC at 8-1-1.
- If you are experiencing difficulty in breathing, chest pain or discomfort, or a severe cough, contact your physician, walk-in clinic, or emergency department. If you are having a medical emergency, call 9-1-1.

::: {.content-visible when-format="markdown"}
{{< accordion_end >}}
{{< accordion_start title="Tips to reduce your exposure to air pollution" initiallyOpen="true" >}}
:::

::: {.content-visible when-format="pdf"}
### Tips to reduce your exposure to air pollution
:::

- Air contaminant levels may be lower indoors but will still be elevated, so stay aware of your symptoms even when you are indoors.
- When indoors, keep windows and doors closed as much as possible.

```{r, results='asis', echo=FALSE}

if (current_month %in% 6:8) {
  cat("- When there is an extreme heat event occurring with poor air quality, prioritize keeping cool.\n")
}

  cat(
    "- Protect your indoor air from outdoor air pollution. Actions can include using a clean, good quality air filter in your ventilation system and/or a certified portable air cleaner that can filter fine particles. Do-it-yourself air cleaners may also be used if other options are unavailable. For more details, see the BC Centre of Control [fact sheet](https://www.bccdc.ca/resource-gallery/Documents/Guidelines%20and%20Forms/Guidelines%20and%20Manuals/Health-Environment/BCCDC_WildFire_FactSheet_BoxFanAirFilters.pdf).\n",
    "- If you must spend time outdoors, a well-constructed, well-fitting and properly worn respirator type mask (such as a NIOSH-certified N95 or equivalent respirator) can reduce your exposure to particulate matter. Even though exposure may be reduced, there can still be risks to health.\n"
  )
```

::: {.content-visible when-format="markdown"}
{{< accordion_end >}}
:::

## Emission reduction actions

::: {.content-visible when-format="markdown"}
{{< accordion_start title="Mandatory actions" initiallyOpen="true" >}}
`r if (params$burnRestrictions > 0) paste("-", burn_ban)`
{{< accordion_end >}}
:::

::: {.content-visible when-format="pdf"}
### Mandatory actions
`r if (params$burnRestrictions > 0) paste("-", burn_ban)`
:::

::: {.content-visible when-format="markdown"}
{{< accordion_start title="Voluntary actions" initiallyOpen="true" >}}
:::

::: {.content-visible when-format="pdf"}
### Voluntary actions
:::

`r voluntary_reduction`

::: {.content-visible when-format="markdown"}
{{< accordion_end >}}
:::

## More information

::: {.content-visible when-format="markdown"}
{{< accordion_start title="Current conditions" initiallyOpen="true" >}}
:::

::: {.content-visible when-format="pdf"}
### Current conditions
:::

```{r final-table, results='asis', echo=FALSE}

# Single pollutant: PM25
  cat(additional_info_PM25, "\n\n")
  print(knitr::kable(final_table, row.names = FALSE, escape = FALSE))

```

::: {.content-visible when-format="markdown"}
{{< accordion_end >}}
:::

::: {.content-visible when-format="pdf"}
### For additional information about air quality in British Columbia
:::

::: {.content-visible when-format="markdown"}
**For additional information about air quality in British Columbia:**

<div class="bcds-card-wrapper"> 
{{< card_start title="Air Quality Health Index" variant="info" logo="/assets/icon_air.svg" >}} Provincial summary of latest index and forecast.

[What's the air like today?] {{< card_end >}} {{< card_start title="Provincal Air Quality Map" variant="info" logo="/assets/icon_air.svg" >}} Provincial air quality data refreshed every hour.

[Latest air quality data] {{< card_end >}}{{< card_start title="Metro Vancouver Air Quality" variant="success" logo="/assets/icon_chart.svg" >}} Warnings and a map of air quality and weather data.

[Air quality data and warnings] {{< card_end >}}
</div>

:::

::: {.content-visible when-format="pdf"}

- View the latest [Air Quality Health Index (AQHI) and forecast][What's the air like today?]
- Visit the provincial [air quality map][Latest air quality data] to view real-time air quality measurements
- Visit the provincial [air quality data webpage][Air quality data] for more information about air quality in B.C.
- Visit Metro Vancouver's [air quality data and warnings page][Air quality data and warnings]

[What's the air like today?]: https://www.env.gov.bc.ca/epd/bcairquality/data/aqhi-table.html
[Latest air quality data]: https://www.env.gov.bc.ca/epd/bcairquality/readings/find-stations-map.html
[Air quality data]:(https://www2.gov.bc.ca/gov/content/environment/air-land-water/air/air-quality)
[Air quality data and warnings]: https://metrovancouver.org/services/air-quality-climate-action/air-quality-data-and-advisories

:::

## Contact

::: {.content-visible when-format="pdf"}
### Media questions regarding this Pollution Prevention Notice
:::

::: {.content-visible when-format="markdown"}
**Media questions regarding this Pollution Prevention Notice:**
{{< card_start width="wide" >}}
:::

`r ENVcontact` 

::: {.content-visible when-format="markdown"}
{{< card_end >}}
:::

::: {.content-visible when-format="pdf"}
### Media questions regarding health implications when air quality is degraded
:::

::: {.content-visible when-format="markdown"}
**Media questions regarding health implications when air quality is degraded:**
{{< card_start  width="wide" >}}
:::

`r paste(HAcontact$html_string, collapse = "\n\n")`

::: {.content-visible when-format="markdown"}
{{< card_end >}}
:::
